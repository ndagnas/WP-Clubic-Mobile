//*******************************************************************************************************************************
// DEBUT DU FICHIER
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// Nom           : ScheduledAgent.cs
// Auteur        : Nicolas Dagnas
// Description   : Implémentation de l'objet ScheduledAgent
// Créé le       : 21/03/2015
// Modifié le    : 06/05/2015
//*******************************************************************************************************************************

//-------------------------------------------------------------------------------------------------------------------------------
#region Using directives
//-------------------------------------------------------------------------------------------------------------------------------
using System;
using System.Net;
using System.Linq;
using System.Text;
using System.Windows;
using System.Xml.Linq;
using System.Diagnostics;
using System.Globalization;
using System.Windows.Media;
using System.IO.IsolatedStorage;
using System.Collections.Generic;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Microsoft.Phone.Shell;
using Microsoft.Phone.Scheduler;
using Microsoft.Phone.Net.NetworkInformation;
//-------------------------------------------------------------------------------------------------------------------------------
#endregion
//-------------------------------------------------------------------------------------------------------------------------------

//*******************************************************************************************************************************
// Début du bloc "Clubic.Scheduler"
//*******************************************************************************************************************************
namespace Clubic.Scheduler
	{

	//   ####   ###   #   #  #####  ####   #   #  #      #####  #### 
	//  #      #   #  #   #  #      #   #  #   #  #      #      #   #
	//   ###   #      #####  ###    #   #  #   #  #      ###    #   #
	//      #  #   #  #   #  #      #   #  #   #  #      #      #   #
	//  ####    ###   #   #  #####  ####    ###   #####  #####  #### 

	//***************************************************************************************************************************
	// Classe ScheduledAgent
	//***************************************************************************************************************************
	#region // Déclaration et Implémentation de l'Objet
	//---------------------------------------------------------------------------------------------------------------------------
	/// <summary>
	/// Définit le comportement de l'agent.
	/// </summary>
	//---------------------------------------------------------------------------------------------------------------------------
	public class ScheduledAgent : ScheduledTaskAgent
		{
		//***********************************************************************************************************************
		#region // Classe FlipTileOptions
		//-----------------------------------------------------------------------------------------------------------------------
		class FlipTileOptions
			{
			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Tile"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromTile ( ShellTile Tile )
				{
				//---------------------------------------------------------------------------------------------------------------
				return FlipTileOptions.FromUri ( Tile.NavigationUri );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Uri"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromUri ( Uri Uri )
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( Uri.OriginalString )
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // All
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=All" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Clubic Mobile"                      ,
							BackTitle               = "Clubic Mobile"                      ,
							SectionID               = 0                                    ,
							SmallBackgroundImage    = "Assets/Tiles/All/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/All/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/All/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/All/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/All/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Bookmarks
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Bookmarks" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Mes favoris"                              ,
							BackTitle               = "Mes favoris"                              ,
							SectionID               = 0                                          ,
							SmallBackgroundImage    = "Assets/Tiles/Bookmarks/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Bookmarks/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Bookmarks/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Bookmarks/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Bookmarks/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Folders
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Folders" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Dossiers"                               ,
							BackTitle               = "Dossiers"                               ,
							SectionID               = 2                                        ,
							SmallBackgroundImage    = "Assets/Tiles/Folders/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Folders/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Folders/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Folders/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Folders/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Hardware
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Hardware" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Hardware"                                ,
							BackTitle               = "Hardware"                                ,
							SectionID               = 1284                                      ,
							SmallBackgroundImage    = "Assets/Tiles/Hardware/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Hardware/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Hardware/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Hardware/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Hardware/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Internet
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Internet" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Internet"                                ,
							BackTitle               = "Internet"                                ,
							SectionID               = 80                                        ,
							SmallBackgroundImage    = "Assets/Tiles/Internet/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Internet/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Internet/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Internet/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Internet/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Mac
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Mac" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Univers Mac"                        ,
							BackTitle               = "Univers Mac"                        ,
							SectionID               = 2360                                 ,
							SmallBackgroundImage    = "Assets/Tiles/Mac/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Mac/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Mac/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Mac/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Mac/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Mobility
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Mobility" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Mobilité"                                ,
							BackTitle               = "Mobilité"                                ,
							SectionID               = 2086                                      ,
							SmallBackgroundImage    = "Assets/Tiles/Mobility/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Mobility/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Mobility/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Mobility/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Mobility/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Multimedia
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Multimedia" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Image et Son"                              ,
							BackTitle               = "Image et Son"                              ,
							SectionID               = 2068                                        ,
							SmallBackgroundImage    = "Assets/Tiles/Multimedia/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Multimedia/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Multimedia/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Multimedia/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Multimedia/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Network
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Network" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Réseaux"                                ,
							BackTitle               = "Réseaux"                                ,
							SectionID               = 424                                      ,
							SmallBackgroundImage    = "Assets/Tiles/Network/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Network/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Network/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Network/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Network/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Pro
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Pro" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Clubic Pro"                         ,
							BackTitle               = "Clubic Pro"                         ,
							SectionID               = 2346                                 ,
							SmallBackgroundImage    = "Assets/Tiles/Pro/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Pro/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Pro/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Pro/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Pro/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Relaxation
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Relaxation" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Détente"                                   ,
							BackTitle               = "Détente"                                   ,
							SectionID               = 2836                                        ,
							SmallBackgroundImage    = "Assets/Tiles/Relaxation/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Relaxation/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Relaxation/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Relaxation/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Relaxation/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Security
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Security" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Securité"                                ,
							BackTitle               = "Securité"                                ,
							SectionID               = 426                                       ,
							SmallBackgroundImage    = "Assets/Tiles/Security/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Security/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Security/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Security/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Security/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Software
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Software" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Logiciel"                                ,
							BackTitle               = "Logiciel"                                ,
							SectionID               = 2164                                      ,
							SmallBackgroundImage    = "Assets/Tiles/Software/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Software/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Software/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Software/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Software/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Technology
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Technology" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Technologie"                               ,
							BackTitle               = "Technologie"                               ,
							SectionID               = 1696                                        ,
							SmallBackgroundImage    = "Assets/Tiles/Technology/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Technology/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Technology/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Technology/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Technology/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Tv
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Tv" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Télévision"                        ,
							BackTitle               = "Télévision"                        ,
							SectionID               = 2358                                ,
							SmallBackgroundImage    = "Assets/Tiles/Tv/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Tv/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Tv/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Tv/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Tv/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------------------------------
				return new FlipTileOptions ()
					{
					//-----------------------------------------------------------------------------------------------------------
					Title                   = "Clubic Mobile"                  ,
					BackTitle               = "Clubic Mobile"                  ,
					SectionID               = 0                                ,
					SmallBackgroundImage    = "Assets/Tiles/FlipTileSmall.png" ,
					BackgroundImage         = "Assets/Tiles/FlipTileMedium.png",
					WideBackgroundImage     = "Assets/Tiles/FlipTileWide.png"  ,
					BackBackgroundImage     = "Assets/Tiles/BackTileMedium.png",
					WideBackBackgroundImage = "Assets/Tiles/BackTileWide.png"  ,
					//-----------------------------------------------------------------------------------------------------------
					};
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//-------------------------------------------------------------------------------------------------------------------
			public string Title                   { get; private set; }
			public string BackTitle               { get; private set; }
			public int    SectionID               { get; private set; }
			public string SmallBackgroundImage    { get; private set; }
			public string BackgroundImage         { get; private set; }
			public string WideBackgroundImage     { get; private set; }
			public string BackBackgroundImage     { get; private set; }
			public string WideBackBackgroundImage { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Structure FlipTileInfos
		//-----------------------------------------------------------------------------------------------------------------------
		struct FlipTileInfos
			{
			//-------------------------------------------------------------------------------------------------------------------
			public string   Title       { get; set; }
			public DateTime PublishDate { get; set; }
			public int      SectionID   { get; set; }
			public string   ArticleID   { get; set; }
			public bool     IsFolder    { get; set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe DownloadDataState
		//-----------------------------------------------------------------------------------------------------------------------
		class DownloadDataState
			{
			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public DownloadDataState ()
				{
				//---------------------------------------------------------------------------------------------------------------
				Items = new List<FlipTileInfos> ();

				this.LastAppLaunch  = StorageSettings.GetValue ( "agent-last-app-launch" , DateTime.MinValue );
				this.LastToastCheck = StorageSettings.GetValue ( "agent-last-toast-check", DateTime.MinValue );

				this.CheckToast = ( ScheduledAgent.ToastDelay > 0 && DateTime.Now.Subtract ( LastToastCheck ).TotalHours > 
				                                                                                     ScheduledAgent.ToastDelay );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			
			//-------------------------------------------------------------------------------------------------------------------
			public bool                CheckToast     { get; private set; }
			public DateTime            LastAppLaunch  { get; private set; }
			public DateTime            LastToastCheck { get; private set; }
			public List<FlipTileInfos> Items          { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------

			//*******************************************************************************************************************
			/// <summary>
			/// Prévient que le processus est finit.
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void NotifyComplete ()
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( this.CheckToast )
					StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe FlipTileInfosComparer
		//-----------------------------------------------------------------------------------------------------------------------
		class FlipTileInfosComparer : IComparer<FlipTileInfos>
			{
			//-------------------------------------------------------------------------------------------------------------------
			public int Compare ( FlipTileInfos X, FlipTileInfos Y )
				{ return ( X.PublishDate > Y.PublishDate ) ? -1 : 1; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		// Section des Constantes
		//-----------------------------------------------------------------------------------------------------------------------
		private const string BaseUri   = "http://ws.m6web.fr/ws.php?idsite=1";
		private const string UserAgent = "Clubic/122 CFNetwork/609.1.4 Darwin/13.0.0";
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		#region // Section du Constructeur
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <remarks>
		/// Le constructeur ScheduledAgent initialise le gestionnaire UnhandledException.
		/// </remarks>
		//-----------------------------------------------------------------------------------------------------------------------
		static ScheduledAgent ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( delegate 
				{ Application.Current.UnhandledException += UnhandledException; } );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Se produit quand une exception est générée.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args">
		/// <b>ApplicationUnhandledExceptionEventArgs</b> qui contient les données d'événement.
		/// </param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UnhandledException ( object Sender, ApplicationUnhandledExceptionEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			Args.Handled = true;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section des Procédures Privées
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Découpe la chaine en plusieurs chaines plus petites
		/// </summary>
		/// <param name="Value">Chaine à découper.</param>
		/// <returns>Chaine découpée.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private static string WordWrap ( string Value, int Size, int MaxLines )
			{
			//-------------------------------------------------------------------------------------------------------------------
			int LastWhiteSpace = -1;
			var Buffer         = new StringBuilder ();
			var Result         = new StringBuilder ();
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			for ( int Index = 0 ; Index < Value.Length && MaxLines > 0 ; Index ++ )
				{
				//---------------------------------------------------------------------------------------------------------------
				char Car = Value[Index];

				if ( Char.IsWhiteSpace ( Car ) ) LastWhiteSpace = Index;

				Buffer.Append ( Car );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				if ( Buffer.Length >= Size && LastWhiteSpace > -1 )
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( MaxLines > 0 )
						{
						//-------------------------------------------------------------------------------------------------------
						Result.Append ( Buffer.ToString ( 0, LastWhiteSpace ) );

						if ( MaxLines > 1 )
							{
							Result.Append ( "&#13;" );
							}
						else
							{
							if ( Index == Value.Length ) Result.Append ( "."     );
							else                         Result.Append ( " ..."  );
							}

						Buffer = new System.Text.StringBuilder ();

						Index  = -1;
						MaxLines --;

						Value = Value.Substring ( LastWhiteSpace + 1 );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			if ( Buffer.Length > 0 && MaxLines > 0 ) Result.Append ( Buffer.ToString () );

			string FinalResult = Result.ToString ();

			if ( ! FinalResult.EndsWith ( "." ) ) FinalResult += ".";

			return FinalResult;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section de Gestion de la Tuile
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static FlipTileData GetTileData ( FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			string XmlContent = String.Empty;
			//-------------------------------------------------------------------------------------------------------------------
				
			//-------------------------------------------------------------------------------------------------------------------
			string TitleClear     = ( string.IsNullOrEmpty ( Config.Title     ) ) ? "Action=\"Clear\"" : "";
			string BackTitleClear = ( string.IsNullOrEmpty ( Config.BackTitle ) ) ? "Action=\"Clear\"" : "";
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile avec article
			//-------------------------------------------------------------------------------------------------------------------
			if ( string.IsNullOrEmpty ( Content ) )
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                   +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                    +
					         "  <wp:Count>0</wp:Count>\n"                                                     +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                               +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n" +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"           +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"   +
					         "  <wp:BackTitle Action=\"Clear\" />\n"                                          +
					         "  <wp:BackContent Action=\"Clear\" />\n"                                        +
					         "  <wp:WideBackContent Action=\"Clear\" />\n"                                    +
					         "  <wp:BackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"            +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"        +
					         " </wp:Tile>\n"                                                                  +
					         "</wp:Notification>";

				XmlContent = string.Format ( XmlContent, TitleClear                 , 
					                                     Config.Title               , 
					                                     Config.SmallBackgroundImage, 
					                                     Config.BackgroundImage     , 
					                                     Config.WideBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile sans article
			//-------------------------------------------------------------------------------------------------------------------
			else
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                          +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                       +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                           +
					         "  <wp:Count>0</wp:Count>\n"                                                            +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                                      +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n"        +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"                  +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"          +
					         "  <wp:BackTitle {5}>{6}</wp:BackTitle>\n"                                              +
					         "  <wp:BackContent>{7}</wp:BackContent>\n"                                              +
					         "  <wp:WideBackContent>{8}</wp:WideBackContent>\n"                                      +
					         "  <wp:BackBackgroundImage IsRelative=\"true\">{9}</wp:BackBackgroundImage>\n"          +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\">{10}</wp:WideBackBackgroundImage>\n" +
					         " </wp:Tile>\n" +
					         "</wp:Notification>";
					
				XmlContent = string.Format ( XmlContent, TitleClear                     , 
					                                     Config.Title                   , 
					                                     Config.SmallBackgroundImage    , 
					                                     Config.BackgroundImage         , 
					                                     Config.WideBackgroundImage     ,
					                                     BackTitleClear                 , 
					                                     Config.BackTitle               , 
					                                     Content                        , 
					                                     WordWrap ( Content, 26, 3 )    ,
					                                     Config.BackBackgroundImage     ,
					                                     Config.WideBackBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return new FlipTileData ( XmlContent );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTiles ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				Deployment.Current.Dispatcher.BeginInvoke ( () =>
					{
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )	
						{ ScheduledAgent.ClearTile ( Tile, FlipTileOptions.FromTile ( Tile ) ); }
					//-----------------------------------------------------------------------------------------------------------
					} );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTile ( ShellTile Tile, FlipTileOptions Images )
			{
			//-------------------------------------------------------------------------------------------------------------------
			ScheduledAgent.UpdateTile ( Tile, Images, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UpdateTile ( ShellTile Tile, FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			try { Tile.Update ( GetTileData ( Config, Content ) ); } catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Section des Procédures de Traitement
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Met à jour les tuiles et lance les notifications.
		/// </summary>
		/// <param name="State">Object ontenant les informations à traiter.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnFinalProcess ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( () =>
				{
				//---------------------------------------------------------------------------------------------------------------
				State.Items.Sort ( new FlipTileInfosComparer () );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// On a du contenue, on récupère la liste des Tuiles
				//---------------------------------------------------------------------------------------------------------------
				var Tiles = new Dictionary<ShellTile, FlipTileOptions> ();

				if ( ScheduledAgent.TileIsActive )
					foreach ( ShellTile Tile in ShellTile.ActiveTiles ) { Tiles[Tile] = FlipTileOptions.FromTile ( Tile ); }
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				int           ToastCount   = 0;
				FlipTileInfos ToastContent = new FlipTileInfos ();
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				try
					{
					//-----------------------------------------------------------------------------------------------------------
					// Lecture des Eléments
					//-----------------------------------------------------------------------------------------------------------
					foreach ( FlipTileInfos Item in State.Items )
						{
						//-------------------------------------------------------------------------------------------------------
						var ProcessedTiles = new List <ShellTile> ();

						foreach ( ShellTile Tile in Tiles.Keys )
							{
							FlipTileOptions TileInfos = Tiles[Tile];

							if ( TileInfos.SectionID == 0 || TileInfos.SectionID == Item.SectionID )
								{
								ScheduledAgent.UpdateTile ( Tile, Tiles[Tile], Item.Title );

								ProcessedTiles.Add ( Tile );
								}
							}

						foreach ( ShellTile Tile in ProcessedTiles ) { Tiles.Remove ( Tile ); }
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						// Est ce qu'on check les Toast ?
						//-------------------------------------------------------------------------------------------------------
						if ( State.CheckToast && Item.PublishDate > State.LastToastCheck )
							{
							//---------------------------------------------------------------------------------------------------
							ToastCount ++;
							ToastContent = Item;
							//---------------------------------------------------------------------------------------------------
							}
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				catch {}
				//---------------------------------------------------------------------------------------------------------------
				finally
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // Un nouveau dossier
					//-----------------------------------------------------------------------------------------------------------
					if ( ToastCount == 1 && ToastContent.IsFolder )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "Nouveau dossier"                                    ,
							Content       = ToastContent.Title                                   ,
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml?Article="           + 
							                ToastContent.ArticleID + "-true" , UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Un nouvel article
					//-----------------------------------------------------------------------------------------------------------
					else if ( ToastCount == 1 && ! ToastContent.IsFolder )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "Nouvel article"                                      ,
							Content       = ToastContent.Title                                    ,
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml?Article="            + 
							                 ToastContent.ArticleID + "-false", UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Plusieurs nouveaux articles
					//-----------------------------------------------------------------------------------------------------------
					else if ( ToastCount > 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "Clubic Mobile"                                      ,
							Content       = string.Format ( "tu as {0} nouveaux articles"        +
							                                   " à lire sur Clubic", ToastCount ),
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml", UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					
					//-----------------------------------------------------------------------------------------------------------
					// On ré-initialise les tuiles non mise à jour
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in Tiles.Keys ) { ScheduledAgent.ClearTile ( Tile, Tiles[Tile] ); }

					State.NotifyComplete ();
					base .NotifyComplete ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				} );
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à la récupération des derniers dossiers.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args"><b>...EventArgs</b> qui contient les données d'événement.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnGetLastFoldersSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			DownloadDataState State = (DownloadDataState)Args.UserState;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// S'il y a eu une erreur ou une exception, on arrête
				//---------------------------------------------------------------------------------------------------------------
				if ( Args.Cancelled                       ) return;
				if ( Args.Error                   != null ) return;
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// Le document doit avoir le bon format
				//---------------------------------------------------------------------------------------------------------------
				var Document = XElement.Parse ( Args.Result );

				if ( Document == null ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				IEnumerable<XElement> XItems = Document.Elements ( "item" );

				foreach ( XElement XItem in XItems )
					{
					//-----------------------------------------------------------------------------------------------------------
					string Title       = XItem.GetString ( "titre"            );
					string publishDate = XItem.GetString ( "date_publication" );
					string ArticleID   = XItem.GetString ( "id"               );

					DateTime PublishDate = DateTime.MinValue;

					DateTime.TryParseExact ( publishDate, "yyyy-MM-dd HH:mm:ss", null, DateTimeStyles.None, out PublishDate );
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					if ( PublishDate >= State.LastAppLaunch )
						{
						//-------------------------------------------------------------------------------------------------------
						State.Items.Add ( new FlipTileInfos ()
							{
							Title       = Title      ,
							PublishDate = PublishDate,
							SectionID   = 2          ,
							ArticleID   = ArticleID  ,
							IsFolder    = true       ,
							} );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally { this.OnFinalProcess ( State ); }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Récupère les dernier dossiers publiés.
		/// </summary>
		/// <returns><b>True</b> si le traitement est en cours, sinon <b>False</b>.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncGetLastFolders ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// On recherche les derniers articles
				//---------------------------------------------------------------------------------------------------------------
				string Uri = BaseUri + "&wsn=getListFolder&wst=content&type=liste&order=when";

				var WebClient = new WebClient ();

				WebClient.Headers["User-Agent"] = UserAgent;

				WebClient.DownloadStringCompleted += this.OnGetLastFoldersSuccess;

				WebClient.DownloadStringAsync ( new Uri ( Uri ), State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à la récupération des derniers articles.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args"><b>...EventArgs</b> qui contient les données d'événement.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnGetLastArticlesSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// S'il y a eu une erreur ou une exception, on arrête
				//---------------------------------------------------------------------------------------------------------------
				if ( Args.Cancelled                       ) return;
				if ( Args.Error                   != null ) return;
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// Le document doit avoir le bon format
				//---------------------------------------------------------------------------------------------------------------
				var Document = XElement.Parse ( Args.Result );

				if ( Document == null ) return;

				DownloadDataState State = (DownloadDataState)Args.UserState;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				IEnumerable<XElement> XItems = Document.Elements ( "item" );

				foreach ( XElement XItem in XItems )
					{
					//-----------------------------------------------------------------------------------------------------------
					string Title       = XItem.GetString ( "titre"            );
					string publishDate = XItem.GetString ( "date_publication" );
					int    SectionID   = XItem.GetString ( "cat"              ).ToInteger ();
					string ArticleID   = XItem.GetString ( "id"               );

					DateTime PublishDate = DateTime.MinValue;

					DateTime.TryParseExact ( publishDate, "yyyy-MM-dd HH:mm:ss", null, DateTimeStyles.None, out PublishDate );
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					if ( PublishDate >= State.LastAppLaunch )
						{
						//-------------------------------------------------------------------------------------------------------
						State.Items.Add ( new FlipTileInfos ()
							{
							Title       = Title      ,
							PublishDate = PublishDate,
							SectionID   = SectionID  ,
							ArticleID   = ArticleID  ,
							IsFolder    = false      ,
							} );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// On passe aux Dossiers
				//---------------------------------------------------------------------------------------------------------------
				CancelNotify = this.AsyncGetLastFolders ( State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally { if ( ! CancelNotify ) base.NotifyComplete (); }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Récupère les derniers articles publiés.
		/// </summary>
		/// <returns><b>True</b> si le traitement est en cours, sinon <b>False</b>.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncGetLastArticles ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// On recherche les derniers articles
				//---------------------------------------------------------------------------------------------------------------
				string Uri = BaseUri + "&wsn=getListNews&wst=content&type=liste";

				var WebClient = new WebClient ();

				WebClient.Headers["User-Agent"] = UserAgent;

				WebClient.DownloadStringCompleted += this.OnGetLastArticlesSuccess;

				WebClient.DownloadStringAsync ( new Uri ( Uri ), State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Agent qui exécute une tâche planifiée.
		/// </summary>
		/// <param name="task">La tâche appelée.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		protected override void OnInvoke ( ScheduledTask task )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! TileIsActive && ToastDelay == 0           ) return;
				if ( ! NetworkInterface.GetIsNetworkAvailable () ) return;

				CancelNotify = this.AsyncGetLastArticles ( new DownloadDataState () );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! CancelNotify )
					{
					//-----------------------------------------------------------------------------------------------------------
					base.NotifyComplete       ();
					ScheduledAgent.ClearTiles ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROCEDURE >> Clear
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void Clear ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			StorageSettings.SetValue ( "agent-last-app-launch" , DateTime.Now                    );
			StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now.AddMinutes ( -30 ) );
			
			ScheduledAgent.ClearTiles ();
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // PROCEDURE >> GetTileData
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Obtiens les infos nécessaires à la création de la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static FlipTileData GetTileData ( Uri Uri )
			{
			//-------------------------------------------------------------------------------------------------------------------
			var TileConfig = FlipTileOptions.FromUri ( Uri );
				
			return ScheduledAgent.GetTileData ( TileConfig, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> TileIsActive
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si la tuile dynamique est active.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static bool TileIsActive
			{
			//-------------------------------------------------------------------------------------------------------------------
			get { return (bool)StorageSettings.GetValue ( "agent-tile-is-active", false ); }
			set {              StorageSettings.SetValue ( "agent-tile-is-active", value ); }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> ToastDelay
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si les notifications sont actives.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static int ToastDelay
			{
			//-------------------------------------------------------------------------------------------------------------------
			get
				{
				object Value = StorageSettings.GetValue ( "agent-toast-delay" );

				if ( Value == null )
					{
					bool Active = StorageSettings.GetValue ( "agent-toast-is-active", false );

					Value = ( Active ) ? (int)1 : (int)0;

					StorageSettings.SetValue ( "agent-toast-delay", (int)Value );
					}
				
				return (int)Value;
				}
			//-------------------------------------------------------------------------------------------------------------------
			set
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( value )
					{
					case 1  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 2  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 4  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					default : StorageSettings.SetValue ( "agent-toast-delay", 0     ); break;
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		}
	//---------------------------------------------------------------------------------------------------------------------------
	#endregion
	//***************************************************************************************************************************

	} // Fin du namespace "Clubic.Scheduler"
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// FIN DU FICHIER
//*******************************************************************************************************************************
